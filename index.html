<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Canvas (Fixed)</title>
    
    <!-- Changed CDN to unpkg and added security attributes to prevent blocking -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; }
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #333; display: flex; height: 100vh; width: 100vw; }

        /* LOGIN */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 999;
            display: flex; justify-content: center; align-items: center; flex-direction: column; color: white;
        }
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; width: 300px; color: #333; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; box-sizing: border-box; border: 2px solid #ddd; border-radius: 6px; text-align: center; font-size: 16px;}
        .btn { width: 100%; padding: 12px; margin: 5px 0; cursor: pointer; border: none; color: white; font-weight: bold; border-radius: 6px; font-size: 16px; }
        .btn-host { background: #2980b9; } .btn-join { background: #27ae60; }
        .status-spinner { margin-top: 20px; font-size: 14px; color: #bdc3c7; display: none; }
        .status-spinner.active { display: block; }

        /* APP */
        #appContainer { display: none; width: 100%; height: 100%; }
        #sidebar { width: 60px; background: #34495e; display: flex; flex-direction: column; align-items: center; padding-top: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.3); z-index: 10; }
        .tool-btn { width: 40px; height: 40px; border-radius: 8px; border: none; background: transparent; color: #ecf0f1; font-size: 18px; margin: 8px 0; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .tool-btn.active { background: var(--accent); color: white; transform: scale(1.1); }
        .color-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #fff; margin: 6px 0; cursor: pointer; }
        
        #main { flex: 1; position: relative; background: #666; display: flex; justify-content: center; align-items: center; }
        #canvasWrapper { position: relative; width: 100%; height: 100%; background: white; overflow: hidden; }
        canvas { display: block; cursor: crosshair; touch-action: none; }
        #pageControls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: #2c3e50; padding: 8px 20px; border-radius: 30px; color: white; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 10; }
        .icon-btn { background: none; border: none; color: white; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2><i class="fas fa-palette"></i> ArtSync</h2>
            <p>Enter Room Name</p>
            <input type="text" id="roomId" placeholder="e.g. MyRoom1">
            <div id="btnGroup">
                <button class="btn btn-host" onclick="initApp('host')">Start as HOST</button>
                <button class="btn btn-join" onclick="initApp('join')">Join as VIEWER</button>
            </div>
            <div class="status-spinner" id="statusArea">
                <i class="fas fa-spinner fa-spin"></i> <span id="statusText">Connecting...</span>
            </div>
        </div>
    </div>

    <!-- CANVAS APP -->
    <div id="appContainer">
        <div id="sidebar">
            <button class="tool-btn active" id="t-pen" onclick="setTool('pen')"><i class="fas fa-pen"></i></button>
            <button class="tool-btn" id="t-eraser" onclick="setTool('eraser')"><i class="fas fa-eraser"></i></button>
            <div style="height:1px; background:#555; width:80%; margin:10px 0;"></div>
            <div class="color-dot" style="background:#000;" onclick="setColor('#000000')"></div>
            <div class="color-dot" style="background:#e74c3c;" onclick="setColor('#e74c3c')"></div>
            <div class="color-dot" style="background:#3498db;" onclick="setColor('#3498db')"></div>
            <div class="color-dot" style="background:#2ecc71;" onclick="setColor('#2ecc71')"></div>
            <div style="height:1px; background:#555; width:80%; margin:auto;"></div>
            <button class="tool-btn" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i></button>
            <button class="tool-btn" onclick="toggleFS()"><i class="fas fa-expand"></i></button>
        </div>
        <div id="main">
            <div id="canvasWrapper">
                <canvas id="cvs"></canvas>
            </div>
            <div id="pageControls">
                <button class="icon-btn" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
                <span id="pgNum">Page 1</span>
                <button class="icon-btn" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
                <button class="icon-btn" onclick="clearCanvas()"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // !!! PASTE YOUR GOOGLE SCRIPT URL HERE !!!
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznWr6pH1DLfDXVAKneaQiWKkf-yQFBwm26o9ecU-Z8grk2X7L_lzWrzxP-c02aWMZ1/exec'; 
        // ==========================================

        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d', { alpha: false });
        const statusText = document.getElementById('statusText');
        const statusArea = document.getElementById('statusArea');
        const btnGroup = document.getElementById('btnGroup');

        const state = {
            isHost: false, roomId: '', tool: 'pen', color: '#000000', lineWidth: 3,
            drawing: false, pages: [], curPage: 0
        };
        const remoteState = { tool: 'pen', color: '#000', lineWidth: 3 };

        const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
        let dc;
        let pollInterval; 

        // --- WEBRTC EVENTS ---
        pc.onconnectionstatechange = () => {
            if(pc.connectionState === 'connected') {
                clearInterval(pollInterval); // Stop polling
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                resize();
                savePage();
            } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                alert("Connection Lost. Please refresh.");
            }
        };

        // --- INIT ---
        async function initApp(role) {
            state.roomId = document.getElementById('roomId').value.trim();
            if(!state.roomId || SCRIPT_URL.includes("YOUR_GOOGLE")) return alert("Check Config");

            btnGroup.style.display = 'none';
            statusArea.classList.add('active');
            state.isHost = (role === 'host');

            if(state.isHost) {
                statusText.innerText = "Creating Offer...";
                dc = pc.createDataChannel("draw");
                setupDC();
                
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                pc.onicecandidate = e => {
                    if(!e.candidate) sendSignal('offer', pc.localDescription);
                };
                
                statusText.innerText = "Waiting for Viewer...";
                poll('answer');
            } else {
                statusText.innerText = "Searching Room...";
                document.getElementById('pageControls').style.display = 'none';
                poll('offer');
            }
        }

        // --- SIGNALING ---
        async function sendSignal(type, data) {
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify({ id: state.roomId, type, sdp: JSON.stringify(data) })
                });
            } catch(e) { console.error("Signal Error", e); }
        }

        function poll(targetType) {
            pollInterval = setInterval(async () => {
                try {
                    // SAFETY CHECK: Stop if already connected
                    if(pc.connectionState === 'connected' || pc.signalingState === "stable" && targetType === 'answer') {
                        clearInterval(pollInterval);
                        return;
                    }

                    const res = await fetch(`${SCRIPT_URL}?id=${state.roomId}`);
                    const json = await res.json();
                    
                    // HOST WAITING FOR ANSWER
                    if(targetType === 'answer' && json.answer) {
                        // ONLY ACCEPT IF WE ARE WAITING FOR IT
                        if(pc.signalingState === "have-local-offer") {
                            clearInterval(pollInterval);
                            statusText.innerText = "Connecting...";
                            await pc.setRemoteDescription(JSON.parse(json.answer));
                        }
                    } 
                    // VIEWER WAITING FOR OFFER
                    else if(targetType === 'offer' && json.offer) {
                        // ONLY ACCEPT IF WE ARE STABLE (Initial state)
                        if(pc.signalingState === "stable") { 
                            clearInterval(pollInterval);
                            statusText.innerText = "Joining...";
                            
                            await pc.setRemoteDescription(JSON.parse(json.offer));
                            
                            pc.ondatachannel = e => { dc = e.channel; setupDC(); };
                            
                            const ans = await pc.createAnswer();
                            await pc.setLocalDescription(ans);
                            
                            pc.onicecandidate = e => {
                                if(!e.candidate) sendSignal('answer', pc.localDescription);
                            };
                        }
                    }
                } catch(e) { console.log("Polling..."); }
            }, 2000);
        }

        function setupDC() {
            dc.onmessage = e => handleMsg(JSON.parse(e.data));
        }

        function send(data) {
            if(dc && dc.readyState === 'open') dc.send(JSON.stringify(data));
        }

        // --- CANVAS ENGINE ---
        function resize() {
            const temp = cvs.toDataURL();
            cvs.width = cvs.parentElement.clientWidth;
            cvs.height = cvs.parentElement.clientHeight;
            ctx.fillStyle = "#ffffff"; // White bg for eraser
            ctx.fillRect(0,0,cvs.width, cvs.height);
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = temp;
        }
        window.onresize = resize;

        function getPos(e) {
            const r = cvs.getBoundingClientRect();
            const t = e.touches ? e.touches[0] : e;
            return { x: t.clientX - r.left, y: t.clientY - r.top };
        }

        function configCtx(c, tool, color, width) {
            c.lineCap = 'round'; c.lineJoin = 'round';
            c.globalCompositeOperation = 'source-over'; 
            if(tool === 'eraser') {
                c.strokeStyle = '#ffffff'; 
                c.lineWidth = 30;
            } else {
                c.strokeStyle = color;
                c.lineWidth = width;
            }
        }

        // --- LOCAL DRAW ---
        cvs.addEventListener('mousedown', start);
        cvs.addEventListener('touchstart', start, {passive:false});
        cvs.addEventListener('mousemove', move);
        cvs.addEventListener('touchmove', move, {passive:false});
        window.addEventListener('mouseup', end);
        window.addEventListener('touchend', end);

        let points = [];

        function start(e) {
            if(!state.isHost && !dc) return; 
            e.preventDefault();
            state.drawing = true;
            const p = getPos(e);
            points = [p];
            
            configCtx(ctx, state.tool, state.color, state.lineWidth);
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
            
            send({ t:'s', x:p.x/cvs.width, y:p.y/cvs.height, c:state.color, w:state.lineWidth, tl:state.tool });
        }

        function move(e) {
            if(!state.drawing) return;
            e.preventDefault();
            const p = getPos(e);
            points.push(p);

            if(points.length > 2) {
                const last = points[points.length-2];
                ctx.quadraticCurveTo(last.x, last.y, (last.x+p.x)/2, (last.y+p.y)/2);
                ctx.stroke();
            } else {
                ctx.lineTo(p.x, p.y);
                ctx.stroke();
            }
            send({ t:'m', x:p.x/cvs.width, y:p.y/cvs.height });
        }

        function end() {
            if(!state.drawing) return;
            state.drawing = false;
            ctx.closePath();
            points = [];
            savePage();
            send({ t:'e' });
        }

        // --- REMOTE DRAW ---
        let rPoints = [];
        function handleMsg(d) {
            const w = cvs.width; const h = cvs.height;
            
            if(d.t === 's') {
                remoteState.tool = d.tl; remoteState.color = d.c; remoteState.lineWidth = d.w;
                const rx = d.x * w; const ry = d.y * h;
                rPoints = [{x:rx, y:ry}];
                configCtx(ctx, remoteState.tool, remoteState.color, remoteState.lineWidth);
                ctx.beginPath();
                ctx.moveTo(rx, ry);
            }
            else if(d.t === 'm') {
                const p = {x: d.x*w, y: d.y*h};
                rPoints.push(p);
                if(rPoints.length > 2) {
                    const last = rPoints[rPoints.length-2];
                    ctx.quadraticCurveTo(last.x, last.y, (last.x+p.x)/2, (last.y+p.y)/2);
                    ctx.stroke();
                } else {
                    ctx.lineTo(p.x, p.y);
                    ctx.stroke();
                }
            }
            else if(d.t === 'e') { ctx.closePath(); rPoints = []; savePage(); }
            else if(d.t === 'pg') { state.curPage = d.i; loadPage(d.i); document.getElementById('pgNum').innerText="Page "+(d.i+1); }
            else if(d.t === 'cls') { ctx.fillStyle="#ffffff"; ctx.fillRect(0,0,w,h); savePage(); }
        }

        // --- UI ---
        function setTool(t) {
            state.tool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(t==='pen'?'t-pen':'t-eraser').classList.add('active');
        }
        function setColor(c) { state.color = c; setTool('pen'); }
        function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        function clearCanvas() {
            if(confirm("Clear Page?")) {
                ctx.fillStyle="#ffffff"; ctx.fillRect(0,0,cvs.width, cvs.height);
                savePage();
                send({t:'cls'});
            }
        }
        // --- PAGES ---
        function savePage() { state.pages[state.curPage] = cvs.toDataURL(); }
        function loadPage(i) {
            ctx.fillStyle="#ffffff"; ctx.fillRect(0,0,cvs.width, cvs.height);
            if(state.pages[i]) {
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                img.src = state.pages[i];
            }
        }
        function changePage(dir) {
            if(!state.isHost) return;
            savePage();
            const next = state.curPage + dir;
            if(next < 0) return;
            state.curPage = next;
            loadPage(next);
            document.getElementById('pgNum').innerText = "Page "+(next+1);
            send({t:'pg', i:next});
        }

        // --- PDF ---
        function downloadPDF() {
            // Safety check if library is blocked
            if(!window.jspdf || !window.jspdf.jsPDF) {
                alert("PDF Library was blocked by your browser. Drawing still works, but PDF export is disabled.");
                return;
            }
            savePage();
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                const w = doc.internal.pageSize.getWidth();
                const h = doc.internal.pageSize.getHeight();
                state.pages.forEach((d, i) => {
                    if(i>0) doc.addPage();
                    if(d) doc.addImage(d, 'PNG', 0, 0, w, h);
                });
                doc.save('art_project.pdf');
            } catch(e) {
                console.error(e);
                alert("Error generating PDF.");
            }
        }
    </script>
</body>
</html>